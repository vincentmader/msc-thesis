% Introduction to Monte Carlo Sampling {{{
\clearpage\section{Introduction to Monte Carlo Sampling}

\todo{Before we start: Take a look at simple examples.} \\

    % Monte Carlo Integration in 1D {{{ 
    \subsection{Monte Carlo Integration in 1D}

        \todo{Consider a function $f$ that is defined on an interval $D\subset\mathbb R$
        (from $x_\text{min}$ to $x_\text{max}$).} \\
        \todo{To demonstrate the basic idea of Monte Carlo integration, and without loss of 
        generality, let us for now assume that the image of $D$ under $f$ follows a Gaussian 
        distribution.}
        \begin{equation}
            f: 
            D \to \mathbb R, 
            x \mapsto \frac{1}{\sqrt{2\pi}\sigma}\exp\bigg(\frac{-(x-\mu)^2}{2\sigma^2}\bigg)
        \end{equation}

        We would now like to calculate an approximate value for the integral 
        \begin{equation}
            I = \int\limits_{x_\text{min}}^{x_\text{max}} f(x) \ \text dx
        \end{equation}

        Sample a total of $\mathcal N_\text{sample} \in \mathbb N$ points from the interval $D$. \\

        \todo{This will be done according to a probability distribution $P(x)$, the definition of 
        which will be the crucial thing to do. (?)} \\

        With $i \in [1, N_\text{sample}] \cap \mathbb N$, let $x_i$ label the chosen values. \\

    % }}}
    % Monte Carlo Integration in 2D {{{ 
    \subsection{Monte Carlo Integration in 2D}

    % }}}

% }}}
% Motivation {{{ 
\section{Motivation}

    Consider again the Smoluchowski equation in \cref{eq:discrete_smoluchowski_equation}.

    When only the process of pure hit-and-stick coagulation is included into the model, the 
    kernel matrix is actually quite sparse. Due to the fact that two particles merge into a 
    single new one, 

    For higher mass grid resolutions $\mathcal N_m$, 
    the integration of this differential equation can quickly become numerically expensive.
    This is due to the fact that we have to evaluate a sum over the three-dimensional
    kernel matrix. 

    % (in pure hit-and-stick coagulation, only two-dimensional)


    As the computational cost of its integration is proportional to the number of terms 
    in the sum that have to be included, it seems feasible that a Monte Carlo sampling of 
    the most relevant terms could be of interest. \\

    The idea here is to identify the most "relevant" collision pairs, i.e. index tuples $(i, j)$,
    where relevance is determined by a specific collision's impact on the overall dust particle 
    mass distribution. \\

    After having defined a sensible sampling probability distribution $P_{ij}^\text{sample}$
    we can, in each time step, randomly select the most relevant index pairs $(i, j)$ and 
    construct a new kernel from that. \\

    The goal here is to decrease the number of terms over which the sum has to be evaluated,
    while still maintaining acceptable accuracy and stability.

    Note: We do \textit{not} sample $i$ and $j$ separately. Instead, we sample pairs $(i, j)$.


    \todo{For every mass value, we are interested in finding out how the number of particles 
    carrying that mass is influenced by collisions of particles carrying every possible 
    combination of mass values.} \\
    \todo{As such, the computational complexity is proportional to $\mathcal N_m^3$}. \\

    \todo{Since this has to be done for each time step, the computational cost of the entire 
    integration is increased by an additional factor $\mathcal N_t$.} \\

    \todo{Also, in principle this has to be done separately at each position in the disk.} \\
    \todo{In the simplified model used throughout the disk, we assumed spherical symmetry, and 
    did not spatially resolve the disk along the $z$-axis.}
    \todo{As such, in this case the computational complexity is proportional to an
    additional factor $\mathcal N_r$}. \\

    \todo{It gets even worse if we want to resolve the disk along all three spatial dimensions.} \\
    \todo{Then, there is an additional factor $\mathcal N_\varphi \cdot \mathcal N_z$.} \\

    \todo{It may be good enough to only resolve the disk along the radial axis, or even to focus 
    on just a single point in the disk. Even then though, it gets more complicated if one wants 
    to build a detailed model of dust particle coagulation.} \\

    \todo{In the discussion up to this point, we made the assumption that all dust particles are 
    perfectly spherically, and can thus be characterized entirely by the mass that they carry.} \\

    \todo{This is of course quite simplistic. In reality, dust particles possess much more complex 
    shapes.}xz    \todo{...}
    \todo{An illustration of the so-called \textit{dust bunnies} resulting from collisions can be 
    seen in [cite].} \\

    \todo{A detailed description ... (impossible?)} \\
    \todo{To at least somewhat include the dynamics of such particles, one can make the assumption 
    that a dust particle can be characterized by not one, but two attributes: In addition to the 
    particle mass, we define the \textit{particle porosity}, which gives a (Masz) for the
    (Packungsdichte) of the particle.} \\

    \todo{Studies including (...) have already been done by [cite].} \\

    \todo{If porosity is included as a second attribute for the dust particles, it is no longer 
    enough to formulate a three-dimensional matrix for the coagulation kernel. Instead, it 
    becomes six-dimensional.} \\
    \todo{The computational complexity increases by an additional factor $\mathcal N_p^3$ (?).}

    \todo{Therefore, the total computational complexity (assuming 3D spatial resolution) 
    becomes proportional to}
    \begin{equation}
        O\big(
            \mathcal N_m^3 \cdot \mathcal N_p^3 \cdot 
            \mathcal N_t   \cdot 
            \mathcal N_r   \cdot \mathcal N_\varphi \cdot \mathcal N_z
        \big)
    \end{equation}

    \todo{The idea of this thesis:} \\
    \todo{Speed up the integration via stochastic sampling of the coagulation kernel.} \\
    \todo{In future studies (where porosity is included) this could lead to drastic improvements 
    in the (integration times) by (excluding less relevant sum terms) (...)} \\

    \todo{Goals?} \\
    \todo{Metrics?} \\
    \todo{Bare minimum: Mass conservation (detailed balance)} \\
    \todo{Then: Accuracy}

% }}}
% Previous Works {{{
\clearpage\section{Previous Works}

% }}}
% Basic Idea {{{ 
\section{Basic Idea}

    % Consider again the Smoluchowski equation in \cref{eq:discrete_smoluchowski_equation}.
    % As the computational cost of its integration is proportional to the number of terms 
    % in the sum that have to be included, it seems feasible that a Monte Carlo sampling of 
    % the most relevant terms could be of interest. \\

    % The idea here is to identify the most "relevant" collision pairs, i.e. index tuples $(i, j)$,
    % where relevance is determined by a specific collision's impact on the overall dust particle 
    % mass distribution. \\

    % After having defined a sensible sampling probability distribution $P_{ij}^\text{sample}$
    % we can, in each time step, randomly select the most relevant index pairs $(i, j)$ and 
    % construct a new kernel from that. \\

    % The goal here is to decrease the number of terms over which the sum has to be evaluated,
    % while still maintaining acceptable accuracy and stability.

    % Note: We do \textit{not} sample $i$ and $j$ separately. Instead, we sample pairs $(i, j)$.

    % The idea is to try to lower the computational cost of integrating the Smoluchowski 
    % equation by including only the most "relevant" sum terms on the right hand side of 

% }}}
% Definition of the Sampling Probability {{{
\section{Definition of the Sampling Probability}

    \todo{Our first task will be to recognize proportionalities, before putting it all together.} \\

    The idea here is to define the sampling probability distribution in such a way that the most 
    often sampled collisions are those that have the largest effect on the temporal evolution of 
    the dust particle mass distribution. \\

    Therefore, it seems plausible that, all other factors being equal, more frequently occuring 
    collisions should also be sampled more frequently. \\

    As such, we can recognize the proportionality relations
    \begin{equation}
        P_{ij} \sim R^\text{coll}_{ij}
    \end{equation}
    as well as 
    \begin{align}
        P_{ij} \sim N_i 
        \ \ \ \text{and} \ \ \
        P_{ij} \sim N_j
    \end{align}

    \todo{Also:}
    \begin{equation}
        P_{ij} \sim m_i
        \ \ \ \text{and} \ \ \
        P_{ij} \sim m_j
    \end{equation}

    Also, it makes sense to define this probability distribution in such a way that the collisions 
    that are most likely to be chosen are those that have the "largest effect" on the particle mass 
    distribution function. With that, we mean those collisions that lead to the largest transfer of 
    mass from one bin to another. \\
    
    We define a \textit{weight matrix} $W_{ij}$ encoding this condition:
    \begin{equation} 
        W_{ij}
            = \sum_{k=1}^{\mathcal N_m} m_k \cdot \big|K_{kij}\big|
    \end{equation}

    \todo{The total probability distribution is then directly proportional to the product of 
          the contributions discussed so far:}
    \begin{equation}
        P_{ij}
            \sim W_{ij}\cdot N_i\cdot N_j\cdot m_i\cdot m_j
    \end{equation}

    To turn this into an actual probability distribution though, we still have to perform a 
    normalization step, to assure that the sum over all probabilities is equal to one:
    \begin{equation}
        \sum_{i=1}^{\mathcal N_m}\sum_{j=1}^{\mathcal N_m}P_{ij}
            \overset{!}{=}1
    \end{equation}

    To do this, we define the sum
    \begin{equation}
        S
            := \sum_{i=1}^{\mathcal N_m} \sum_{j=1}^{\mathcal N_m}
               W_{ij} \cdot N_i \cdot N_j \cdot m_i \cdot m_j
    \end{equation}
    and, with this, the normalized probability distribution
    \begin{equation}
        P_{ij}
            = \frac{W_{ij} \cdot N_i \cdot N_j \cdot m_i \cdot m_j}{S}
    \end{equation}

% }}}
% First tests {{{ 
    \subsection{First Tests (\todo{rename})}

    \todo{Test (also for other sampling methods):}
    $$K_\text{complete}=K(\mathcal{N}_s=\mathcal{N}_m^2)$$

    Observations:
    \begin{itemize}
        \item Equilibrium is reached more slowly \\ 
            (Makes sense: Some terms are ignored.) \\
            (\todo{Quantify gain! Plot!})
        \item There are fluctuations \\ 
            (Makes sense: Some terms are ignored.)
        \item For constant sampling density, accuracy increases with mass grid resolution \\
            (\todo{Quantify gain! Plot!})
        \item For constant mass grid resolution, accuracy increases with sampling density \\
            (\todo{Quantify gain! Plot!})
        \item ...
    \end{itemize}

% }}}
% Sampling "without returning" {{{ 
\section{Sampling "without returning"}

    The first case that we will consider will make use of "sampling without returning". Here, a 
    particle pair $(i, j)$ is only allowed to be chosen once per time step.

    \todo{Plot probability distribution for various times.}
    \todo{Plot $n(m,t)$ for various sampling densities.}
    \todo{Plot $\deriv{n}{t}$ against sampling density, for constant mass grid resolution.}
    \todo{Plot $\deriv{n}{t}$ against mass grid resolution, for constant sampling density.}

% }}}
% Sampling "with returning" {{{ 
\section{Sampling "with returning"}

    % Now, we will consider the case of "sampling with returning", i.e. we will now allow particle 
    % pairs to be chosen more than once per time step.

% }}}

\todo{sampling density} \\
sample only half of kernel matrix $K_{kij} = K_{kji}$ (only "upper left" half) \\

% \clearpage

% \begin{table}[h!]
%     \begin{center}
%     \caption{\todo{error vs. sampling density}}
%     \begin{tabular}{r r r r r r r}
%               id 
%             & $\mathcal N_m$  
%             & $\mathcal N_\text{sample}$  
%             & $\rho_\text{sample}$  
%             & $\rho_\text{sample}^\text{total}$        
%             & ($\Delta \rho_\text{dust}$)
%             & $\Delta \rho_\text{dust}^\text{rel}$        
%             \\
%             \hline
%                 0 & & & 0.1 & & x & y \\
%                 1 & & & 0.2 & & x & y \\
%                 3 & & & 0.4 & & x & y \\
%                 3 & & & 0.6 & & x & y \\
%                 3 & & & 0.8 & & x & y \\
%                 3 & & & 1.0 & & x & y \\
%     \end{tabular}
%     \end{center}
% \end{table} 
% \begin{table}[h!]
%     \begin{center}
%     \caption{\todo{error vs. mass grid resolution}}
%     \begin{tabular}{r r r r r r r}
%               id 
%             & $\mathcal N_m$  
%             & $\mathcal N_\text{sample}$  
%             & $\rho_\text{sample}$  
%             & $\rho_\text{sample}^\text{total}$        
%             & ($\Delta \rho_\text{dust}$)
%             & $\Delta \rho_\text{dust}^\text{rel}$        
%             \\
%             \hline
%                 0 &  25 & & & & x & y \\
%                 1 &  50 & & & & x & y \\
%                 3 & 100 & & & & x & y \\
%                 3 & 200 & & & & x & y \\
%                 3 & 250 & & & & x & y \\
%                 3 & 500 & & & & x & y \\
%     \end{tabular}
%     \end{center}
% \end{table} \ \\ 

\todo{Plot eff. sampling density vs. sampling density for various mass grid resolutions.} \\
\todo{Plot eff. sampling density vs. mass grid resolution for various sampling densities.} \\

\todo{Plot density error vs. mass grid resolution for various sampling densities.} \\
\todo{Plot density error vs. max. sampling density for various mass grid resolutions.} \\
\clearpage


% \begin{table}[h!]
%     \begin{center}
%     \caption{}
%     \begin{tabular}{r r r r r r}
%               id 
%             & $\mathcal N_m$  
%             & $\mathcal N_\text{sample}$  
%             & $\rho_\text{sample}$  
%             & $\rho_\text{sample}^\text{total}$        
%             & $\Delta \rho$        
%             \\
%                 0 & (25) &      & & & x \\
%                 1 &  50  &      & & & x \\
%                 2 & 100  &      & & & x \\
%                 3 & 250  &      & & & x \\
%                 4 & 500  &      & & & x \\
%     \end{tabular}
%     \end{center}
% \end{table} \ \\ 


% % \begin{table}[h!]
% %     \begin{center}
% %     \caption{}
% %     \begin{tabular}{l & l}
% %         $\mathcal N_m$  
% %         & $\mathcal N_\text{sample}$  
% %     \end{tabular}
% %     \end{center}
% % \end{table} \ \\ 

% \begin{table}[h!]
%     \begin{center}
%     \caption{}
%     \begin{tabular}{r r}
%               $\mathcal N_m$  
%             & $\rho_\text{sample}$        
%             \\
%                 25 &  \\
%                 50 &  \\
%                100 &  \\
%                250 &  \\
%                500 &  \\
%     \end{tabular}
%     \end{center}
% \end{table} \ \\ 

% \begin{table}[h!]
%     \begin{center}
%     \caption{}
%     \begin{tabular}{r r r r r}
%               id 
%             & $\mathcal N_m$  
%             & $\mathcal N_\text{sample}$  
%             & $\rho_\text{sample}$  
%             & $\rho_\text{sample}^\text{total}$        
%             \\
%                 0 & (25) &      & & \\
%                 1 &  50  &      & & \\
%                 2 & 100  &      & & \\
%                 3 & 250  &      & & \\
%                 4 & 500  &      & & \\
%     \end{tabular}
%     \end{center}
% \end{table} \ \\ 

% \begin{table}[h!]
%     \begin{center}
%     \caption{}
%     \begin{tabular}{}
%               $\mathcal N_m$  
%             & $\mathcal N_\text{sample}$  
%             & $\rho_\text{sample}$  
%             & $\rho_\text{mc}^\text{tot}$        
%             \\
%                 (25)    & & & \\
%                  50     & & & \\
%                 100     & & & \\
%                 200     & & & \\
%     \end{tabular}
%     \end{center}
% \end{table} \ \\ 



\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{105/coag=True frag=False rho_sample=0.5 P_ij.pdf}
    }
    \caption{
        $P_{ij}^\text{sample}$ for
        $\rho_\text{sample} = 0.5$,
        $\mathcal N_m = 50$
    }
\end{figure} 
\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{105/coag=True frag=False rho_sample=0.5 S_ij.pdf}
    }
    \caption{
        $\rho_\text{sample} = 0.5$,
        $\mathcal N_m = 50$
    }
\end{figure} 
\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{
        104/3x2 rho_d vs. m, t, rho_sample, N_m=50, coag=True, frag=False.pdf}
    }
    \caption{only hit-and-stick coagulation}
\end{figure} 

\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{105/coag=True frag=False rho_sample=0.5 P_ij.pdf}
    }
    \caption{
        $P_{ij}^\text{sample}$ for
        $\rho_\text{sample} = 0.5$,
        $\mathcal N_m = 50$
    }
\end{figure} 
\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{105/coag=True frag=True rho_sample=0.5 S_ij.pdf}
    }
    \caption{
        $\rho_\text{sample} = 0.5$,
        $\mathcal N_m = 50$
    }
\end{figure} 
\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{
        104/3x2 rho_d vs. m, t, rho_sample, N_m=50, coag=True, frag=True.pdf}
    }
    \caption{"full model": coagulation + fragmentation}
\end{figure} 

% \clearpage
% \begin{figure}[h!]
%     \makebox[\textwidth]{
%         \includegraphics[width=\paperwidth]{105/coag=False frag=True rho_sample=0.5 P_ij.pdf}
%     }
%     \caption{\todo{}}
% \end{figure} 
% \clearpage
% \begin{figure}[h!]
%     \makebox[\textwidth]{
%         \includegraphics[width=\paperwidth]{105/coag=False frag=True rho_sample=0.5 S_ij.pdf}
%     }
%     \caption{\todo{what $\rho_\text{sample}$?}}
% \end{figure} 
% \clearpage
% \begin{figure}[h!]
%     \makebox[\textwidth]{
%         \includegraphics[width=\paperwidth]{
%         104/3x2 rho_d vs. m, t, rho_sample, N_m=50, coag=False, frag=True.pdf}
%     }
%     \caption{\todo{only fragmentation}}
% \end{figure} 



\clearpage\subsection{Accuracy and Stability}

\begin{align}
    \Delta_\text{stability}(t)=\sum_i \frac{\rho^d_i(t) - \rho^d_i(t=0)}{\rho^d_i(t=0)}
\end{align}
\begin{align}
    \Delta_\text{accuracy}(t)=\sum_i \frac{\rho^d_i(t) - \rho^c_i(t)}{\rho^c_i(t)}
\end{align}

\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{106/accuracy_and_stability_vs_sampling_density}
    }
    \caption{
        \todo{Accuracy and Stability for various sampling densities} \\
        \todo{Stability down to machine precision is given} \\
    }
\end{figure}

\todo{how to quantify accuracy?}
\begin{itemize}
    \item average over multiple runs
\end{itemize}

Let $\rho = \rho^\text{dust}$.
\begin{align}
    \rho^\text{dust}
        &= \sum_{i=1}^{\mathcal{N}_m} \rho_i%^\text{dust} 
    \\
    \rho_i%^\text{dust}
        &= n_i \cdot m_i \cdot \Delta m_i 
\end{align}
\begin{align}
    \Delta\rho_\text{A}
        &= \sqrt{\sum_{i=1}^{{\mathcal N}_m} \big(
            \Delta\rho_i%^\text{dust}
        \big)^2} 
        = \sqrt{\sum_{i=1}^{{\mathcal N}_m} \bigg(
            \rho_i^\text{sampled} - \rho_i^\text{complete}
        \bigg)^2} 
\end{align}
\begin{align}
        \rho &= \sum_{i=1}^{\mathcal{N}_m} \rho_i \\
    \Delta\rho_\text{B} &= \rho - \rho^\text{complete} \\
\end{align}

% \clearpage
% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=\textwidth]{
%         3x2 rho_d vs. m, t, rho_sample, N_m=25, enable_fragmentation=False.pdf}
%     \caption{}
% \end{figure} 
% \clearpage
% \begin{figure}[h!]
%     \centering
%     \includegraphics[width=\textwidth]{
%         3x2 rho_d vs. m, t, rho_sample, N_m=25, enable_fragmentation=True.pdf}
%     \caption{}
% \end{figure} 



\clearpage


\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{107/dMdt vs t vs rho_sample, coag=True, frag=True.pdf}
    }
    \caption{
        temporal derivative (RMS)
        $\sqrt{ \sum_{i=1}^{\mathcal N_m} \left( \frac{\Delta \rho_i}{\Delta t} \right)^2 }$
        (full model)
    }
\end{figure}
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{107/dMdt vs t vs rho_sample, coag=True, frag=False.pdf}
    }
    \caption{
        temporal derivative (RMS)
        $\sqrt{ \sum_{i=1}^{\mathcal N_m} \left( \frac{\Delta \rho_i}{\Delta t} \right)^2 }$
        (pure coagulation)
    }
\end{figure}
% \begin{figure}[h!]
%     \makebox[\textwidth]{
%         \includegraphics[width=\paperwidth]{107/dMdt vs t vs rho_sample, coag=False, frag=True.pdf}
%     }
%     \caption{only fragmentation}
% \end{figure}


\clearpage
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{109/percentage non-zero kernel, coag=True, frag=True.pdf}
    }
    \caption{
        ratio of non-zero kernel entries over times
        (full model)
    }
\end{figure}
\begin{figure}[h!]
    \makebox[\textwidth]{
        \includegraphics[width=\paperwidth]{109/percentage non-zero kernel, coag=True, frag=False.pdf}
    }
    \caption{
        ratio of non-zero kernel entries over times
        (pure coagulation)
    }
\end{figure}
% \clearpage
% \begin{figure}[h!]
%     \makebox[\textwidth]{
%         \includegraphics[width=\paperwidth]{109/percentage non-zero kernel, coag=False, frag=True.pdf}
%     }
%     \caption{only fragmentation}
% \end{figure}

\clearpage
Integrate Smoluchowski equation up to time $t=X?$.
Using the particle mass distribution function at that point in time, 
calculate the probability density $P_{ij}^\text{sample}$.

With this probability distribution, sample the kernel multiple times $\mathcal N_L$. % TODO Rename.
For each time $l$, "perform the summation" to forward the mass distribution by one time step.
Using that new mass distribution, calculate the numerical temporal derivative
\begin{equation}
    \frac{\Delta \rho_i^l}{\Delta t} = \frac{\Delta n_i^l(t)}{\Delta t} \cdot m_i \cdot \Delta m_i
\end{equation}

Calculate the average temporal derivative
\begin{equation}
    \frac{\Delta \rho^\text{avg}_i}{\Delta t} 
    = \sum_{l=1}^{\mathcal N_L} \frac{\Delta n_i^l(t)}{\Delta t} \cdot m_i \cdot \Delta m_i
\end{equation}

\todo{Plot $\frac{\rho_i^\text{avg}}{\Delta t}$ vs. $l$ or $\mathcal N_L$.} \\
\todo{Plot $\frac{\rho_i^\text{avg}}{\Delta t}$ $\rho_\text{sample}$.} \\
\todo{Plot $\frac{\rho_i^\text{avg}}{\Delta t}$ $\mathcal N_m$.}


% Sample kernel using probability from mass distribution.
% Calculate numerical temporal derivative
% \todo{Perform $\mathcal N_\text{r}$ runs with .}
% \todo{Plot }
