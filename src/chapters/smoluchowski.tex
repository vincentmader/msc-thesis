% The Smoluchowski Equation {{{ 
\section{The Smoluchowski Equation}

    Let us now turn our attention to a certain integro-differential equation, which serves as the
    centerpiece of the dust particle coagulation model that this thesis is built upon. \\

    The so-called \textit{Smoluchowski equation} provides a mathematical framework commonly used 
    to describe the process of particle aggregation, or \textit{coagulation}, into larger and 
    larger structures. \\

    This population balance equation is used in a wide range of physical and biological contexts. 
    (examples?) \\

    It is named after the Polish physicist Marian Smoluchowski, due to his treatment of the 
    equation in 1916 \cite{smoluchowski_1916}. \\

    % \todo{ODE or PDE?} \\
    \todo{For each choice of \textit{kernel function}, there exists a unique solution (cite).}
    (and initial conditions)

    % Continuous Formulation {{{
    \subsection{Continuous Formulation}

        \todo{For the evolution of the particle mass distribution function, (depending 
        \textit{only} on the particle mass), the Smoluchowski equation in its most general form 
        reads:}
    
        \begin{equation}
            \label{eq:continuous_smoluchowski_equation}
            \pderiv{n}{t}(m)
                =
                    \int\limits_0^\infty
                    \int\limits_0^\infty
                    K(m,m',m'')
                    \cdot n(m')
                    \cdot n(m'')
                    \ \dd m'
                    \ \dd m''
        \end{equation}

        \todo{Here, the term $K(m, m', m'')$ labels the \textit{coagulation kernel}. 
        It carries the information about how the number of particles with mass $m$ changes with 
        time under the influence of collisions between particles with masses $m'$ and $m''$.} \\

        \todo{We will discuss it in [cite section], and [coag-section] and [frag-section].}
 
    % }}}
    % Discretized Formulation {{{ 
    \newpage\subsection{Discretized Formulation}

        \todo{Now, discretize the Smoluchowski equation.} \\

        To do this, we perform the following two mappings:
        \begin{enumerate}
            \item Replace temporal derivative of particle mass distribution function with 
                finite difference.
                \begin{equation}
                    \pderiv{n}{t} \to \frac{\Delta n}{\Delta t}
                \end{equation}
            \item Replace integral over particle mass axis with discrete sum.
                \begin{equation}
                    \int_0^\infty \dd m' \to \sum_{i=1}^{\mathcal N_m} \Delta m_i
                    \ \ \ \text{and}\ \ \
                    \int_0^\infty \dd m'' \to \sum_{j=1}^{\mathcal N_m} \Delta m_j
                \end{equation} 
        \end{enumerate}

        \todo{This results in:}
        \begin{equation}
            \label{eq:discrete_smoluchowski_equation}
            \pderiv{n_k}{t}
                \approx \sum_{i=1}^{\mathcal N_m}\sum_{j=1}^{\mathcal N_m}
                    K(m_k,m_i,m_j)\cdot n_i\cdot n_j\cdot\Delta m_i\cdot\Delta m_j
        \end{equation}
        % TODO Later on I talk about `del n / del t` instead of `Delta n / Delta t`.
        %    -> Decide on which one of these to use.
    
        Let us define
        \begin{equation}
            K_{kij}
                := K(m_k,m_i,m_j)\cdot\Delta m_k
        \end{equation}
    
        If, in addition, we make use of the relationship $N_i=n_i\cdot\Delta m_i$ that was defined 
        in (\todo{cite}), then we can rewrite the Smoluchowski equation as
        \begin{equation}
            \pderiv{N_k}{t}
                \approx \sum_{i=1}^{\mathcal N_m}\sum_{j=1}^{\mathcal N_m} K_{kij}\cdot N_i\cdot N_j
        \end{equation}
    
    % }}}

% }}}
% The Kernel {{{ 
\newpage\section{The Kernel}

    In the following, we will factorize the kernel into two separate terms:
    \begin{equation}
        K(m,m',m'') = R(m',m'') \cdot X(m,m',m'') 
    \end{equation}

    The idea behind this distinction is the following: 
    \begin{enumerate}
        \item The first term $R(m',m'')$ is used to encode information about 
            \textit{how often collision events occur} per unit time between a given
            pair of particles carrying the masses $m'$ and $m''$. \\
            (\todo{It is defined as in [cite], separately for coagulation and fragmentation})
        \item In contrast to that, the second term $X(m,m',m'')$ helps us understand 
            \textit{how this affects the number of particles} carrying a mass value $m$ under any
            such collision, i.e. it gives information about how matter is redistributed onto the
            range of possible masses.
            (\todo{for each collision})
    \end{enumerate}

    % \todo{Talk about units! (not 1/second)} \\

    \todo{Kernel symmetry:} 
    \begin{itemize}
        \item \todo{(only use "upper left" half of the matrix)}
    \end{itemize}

    % \clearpage
    % \todo{...} \\

    % \todo{The second term, on the other hand, will be used to encode how the initial masses 
    % $m'$ and $m''$ are then distributed onto the range of particles resulting from such a 
    % collision, each carrying a mass of value $m$.} \\

    % Physical Units {{{ 
    % \subsection{Physical Units (\todo{Is this section needed?})}
    % }}}
    % Discretization {{{ 
    % \subsection{Discretization}

        % \begin{equation}
        %     K(m, m', m'')
        %         \to
        %             K_{kij}
        %         =
        %             K(m_k, m_i, m_j) \cdot\Delta m_k
        % \end{equation}

    % }}}
    % Decomposition into Gain and Loss Terms {{{ 
    \clearpage\subsection{Decomposition into Gain and Loss Terms}

        We can further decompose the "redistribution" kernel $K(m,m',m'')$ into a negative and a 
        positive contribution, which in the following we will address as the \textit{loss} and 
        \textit{gain} term $L$ and $G$, respectively:
        \begin{equation}
            K(m,m',m'') = L(m, m', m'') + G(m, m', m'') 
        \end{equation}
        % \begin{equation}
        %     K(m,m',m'') = R(m',m'') \cdot \bigg[G(m, m', m'') + L(m, m', m'')\bigg]
        % \end{equation}

        We will define these two terms as follows:
        \begin{align}
            L(m, m', m'') 
                &:= -R(m',m'') \cdot \frac{1}{2} \bigg[\delta_D(m-m')+\delta_D(m-m'')\bigg] \\
            G(m, m', m'') 
                &:= +R(m',m'') \cdot f(m, m', m'') 
        \end{align}

        \todo{The two separate Dirac distributions in the square brackets relate to the symmetry 
        of the kernel, which satisfies the following relationship.} \\
        \todo{Continuous case:}
        \begin{equation}
            K(m,m',m'') = K(m,m'',m')
        \end{equation}
        \todo{Discrete case:}
        \begin{equation}
            K_{kij} = K_{kji}
        \end{equation}
        \todo{I.e.: It is irrelevant whether a particle A collides with a particle B, or whether 
        a particle B collides with particle A. These are the same collision events}. \\
        \todo{They are both encoded into the kernel though, which is why we need the factor $1/2$ 
        in order to not count them twice.} \\
        \todo{For the numerical integration that we will do later, we will of course not sum over 
        the entire kernel and divide by 2 afterwards. That would lead to an unnecessary factor 2 
        in the necessary computations. Instead, we will map the lower right half of the kernel 
        matrix onto the top left (as we will see later).} \\

        When evaluating the sum in [cite Smol. eq.] during integration, this will have the following 
        effect:
        \begin{enumerate}
            \item For each collision between two particles $m'$ and $m''$, a single particle will 
                be removed from the distribution for each of these two masses, hence the term $-1$ 
                in the equation above. (\todo{fix this})
            \item At the same time, the total mass involved in the collision, which is given by the 
                sum $m_\text{tot} = m' + m''$, will have to be "redistributed" onto the "distribution" 
                in some sensible manner, necessarily respecting the conservation of mass. How exactly 
                this is done is determined by a function $f(m,m',m'')$, which will look differently 
                depending on whether one wishes to model pure (hit-and-stick) coagulation, or
                whether one is interested in collisions leading to particle fragmentation instead.
        \end{enumerate}

        \todo{Plugging this into [cite Smol. eq.]...}
        \begin{align}
            \deriv{n}{t} =
            &-\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot 
                \frac{1}{2}\bigg[\delta_D(m-m')+\delta_D(m-m'')\bigg]
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm'' \\
            &+\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot f(m,m',m'')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm'' 
        \end{align}
        \todo{which, if we pull apart the two terms in the square brackets, can be 
        equivalently written as}
        \begin{align}
            \deriv{n}{t} =
            &-\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot \frac{1}{2}\delta_D(m-m')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm'' \\
            &-\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot \frac{1}{2}\delta_D(m-m'')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm'' \\
            &+\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot f(m,m',m'')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm''
        \end{align}

        \todo{Making use of the relationship}
        \begin{equation}
            f(x_0) = \int\limits_{-\infty}^{\infty} f(x) \cdot \delta_D(x-x_0) \ \dd x 
        \end{equation}
        \todo{for the Dirac delta distribution, ...} \\

        \todo{...we can reduce the 2D integral in each of the first two terms a 1D integral.}
        \begin{align}
            \deriv{n}{t} =
            &-\frac{1}{2} \int\limits_0^\infty R(m,m'') \cdot n(m) \cdot n(m'') \ \text dm'' \\
            &-\frac{1}{2} \int\limits_0^\infty R(m',m) \cdot n(m') \cdot n(m) \ \text dm' \\
            &+\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot f(m,m',m'')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm''
        \end{align}

        \todo{Since we can rename $m'' \to m'$ without changing ...} \\
        \todo{... and $R(m,m') = R(m',m)$ (...)} \\
        \todo{...}
        \begin{align}
            \deriv{n}{t} =
            &-\int\limits_0^\infty R(m,m') \cdot n(m) \cdot n(m') \ \text dm' \\
            &+\int\limits_0^\infty \int\limits_0^\infty R(m',m'') \cdot f(m,m',m'')
                \cdot n(m') \cdot n(m'') \ \text dm' \ \text dm''
        \end{align}

        (\todo{Explain ...})

        \todo{The discretized analogon to [cite last eq.] according to [cite sec. on discr.] reads}
        \begin{equation}
            \deriv{N}{t} =
            -\sum_{i=1}^{\mathcal N_m} 
                R_{ij} \cdot N_i \cdot N_j 
            +\sum_{i=1}^{\mathcal N_m} \sum_{j=1}^{\mathcal N_m} 
                R_{ij} \cdot f_{kij} \cdot N_i \cdot N_j
        \end{equation}
        (\todo{Define $f_{kij}$})

    % }}}
    % Decomposition into Coagulation and Fragmentation Kernel {{{ 
    \clearpage\subsection{Decomposition into Coagulation and Fragmentation Kernel}

        As mentioned above [where?], we will define two separate kernels to describe the influence 
        of both collisions leading to coagulation as well as fragmentation events, respectively:
        \begin{align}
            K^\text{coag}(m,m',m'') &= R^\text{coag}(m',m'') \cdot X^\text{coag}(m,m',m'') \\
            K^\text{frag}(m,m',m'') &= R^\text{frag}(m',m'') \cdot X^\text{frag}(m,m',m'')
        \end{align}

        After having done this, we can add these two sub-kernels to arrive at the total kernel:
        \begin{equation}
            X(m,m',m'') = X^\text{coag}(m,m',m'') + X^\text{frag}(m,m',m'')
        \end{equation}

        For completeness, it should be said that we could add another sub-kernel 
        $K^\text{bounce}$ to the sum, for collisions leading to particle bouncing events.
        We might as well neglect this though, since bouncing does not affect the dust particle mass 
        distribution in any way, and therefore we can set
        \begin{equation}
            K^\text{bounce}(m,m',m'') 
            = R^\text{bounce}(m',m'') \cdot \underbrace{X^\text{bounce}(m,m',m'')}_{=0}
        \end{equation}

    % }}}
    % Definition of the Kernel Mass Error {{{ 
    \subsection{Definition of the Kernel Mass Error}

        Here, it makes sense to distinguish between various definitions:

        \begin{enumerate}

            \item Kernel mass error $\Delta K_{ij}$ per second (and per density!)
                (given in \SI{}{\kilogram\ \meter^3\ \second^{-1}}): 
                \begin{align}
                    \Delta K_{ij} &= \sum_{k=1}^{\mathcal N_m} m_k \cdot K_{kij}
                \end{align}

            \item Kernel mass error $\Delta X_{ij}$ per collision 
                (given in \SI{}{\kilogram}): 
                \begin{align}
                    \Delta X_{ij}
                        = \frac{\Delta K_{ij}}{R^\text{coll}_{ij}}
                        = \sum_{k=1}^{\mathcal N_m} m_k \cdot X_{kij}
                \end{align}

            \item Relative kernel mass error $\Delta X_{ij}^\text{rel}$ per collision 
                (dimensionless):
                \begin{align}
                    \Delta X_{ij}^\text{rel} 
                        &= \sum_{k=1}^{\mathcal N_m} \frac{m_k}{m_i+m_j} \cdot X_{kij}
                \end{align}

            \item Total kernel error $\Delta X^\text{rel}$
                (dimensionless as wel):
                \begin{align}
                    \Delta X^\text{rel} &= \sqrt{
                        \sum_{i=1}^{\mathcal N_m}
                        \sum_{j=1}^{\mathcal N_m}
                        \big(\Delta X_{ij}^\text{rel}\big)^2
                    }
                \end{align}

        \end{enumerate}

        \todo{The last definition is what we will use to classify the "goodness" of our kernel.} 

    % }}}

% }}}
% Analytical Solutions {{{ 
\newpage\section{Analytical Solutions}

    Analytical solutions to the Smoluchowski coagulation equation exist if, and only if the kernel
    takes on one of the following three forms:
    \begin{enumerate}
        \item constant kernel
            $$K=1$$
        \item linear kernel
            $$K=m_1+m_2$$
        \item quadratic kernel
            $$K=m_1\cdot m_2$$
    \end{enumerate}
    \todo{Rewrite with $m$, $m'$, and $m''$.} \\
    \todo{Rewrite with $K$ and $X$. Take which?}

    % Constant Kernel {{{ 
    \subsection{Constant Kernel}

    \todo{Constant Kernel:} (general enough?)
    \begin{equation}
        K(m, m', m'')
            = 1
    \end{equation}

    \todo{Smoluchowski equation with constant kernel:}
    \begin{equation}
        \pderiv{n}{t}(m)
            = 
                \int\limits_0^\infty \int\limits_0^\infty
                n(m') \cdot n(m'')
                \ \dd m' \ \dd m''
    \end{equation}

    % }}}
    % Linear Kernel {{{ 
    \subsection{Linear Kernel}

    \todo{Linear Kernel:} (general enough?)
    \begin{equation}
        K(m, m', m'')
            = m' + m''
    \end{equation}

    \todo{Smoluchowski equation with linear kernel:}
    \begin{equation}
        \pderiv{n}{t}(m)
            = 
                \int\limits_0^\infty \int\limits_0^\infty
                (m' + m'') \cdot
                n(m') \cdot n(m'')
                \ \dd m' \ \dd m''
    \end{equation}

    % }}}
    % Quadratic Kernel {{{ 
    \subsection{Quadratic Kernel}

    \todo{Quadratic Kernel:} (general enough?)
    \begin{equation}
        K(m, m', m'')
            = m' \cdot m''
    \end{equation}

    \todo{Smoluchowski equation with quadratic kernel:}
    \begin{equation}
        \pderiv{n}{t}(m)
            = 
                \int\limits_0^\infty \int\limits_0^\infty
                (m' \cdot m'') \cdot
                n(m') \cdot n(m'')
                \ \dd m' \ \dd m''
    \end{equation}

    % }}}

% }}}
% Numerical Integration {{{
\newpage\section{Numerical Integration}

    % Definition of the Integration Mass Error {{{ 
    \subsection{Definition of the Integration Mass Error}

        \todo{Let us now take a look at how to use numerical integration of the discretized 
        Smoluchowski coagulation equation to arrive at an approximate solution for the temporal 
        evolution of the particle mass distribution function under the influence of dust particle 
        collisions.} \\

        \todo{To be able to compare different numerical schemes quantitatively, both with respect 
        to their accuracy as well as stability properties, it makes sense to first define a measure 
        of the total error of the integration.} \\

        \todo{As we already know from eq [...], the mass volume density can be calculcated from the 
        particle mass distribution.} \\ % TODO Rewrite this.

        \todo{Let $t_i$ and $t_f$ label the time at the start and end of the integration, respectively.
        The mass volume density's value at these two points in time can be written as:}

        \begin{align}
            % TODO Define `t_i` and `t_f`. Note that `t_i = t_0`
            % TODO Use subscript or superscript for `i` and `f` ?
            \rho_\text{i}
                &:=\sum_{k=0}^{\mathcal N_m} m_k\cdot n_k(t=t_\text{i})\cdot\Delta m_k
            \\
            \rho_\text{f}
                &:=\sum_{k=0}^{\mathcal N_m} m_k\cdot n_k(t=t_\text{f})\cdot\Delta m_k
        \end{align}

        \todo{After the integration has finished, the relative mass error (more specifically: density 
        error) then reads:}
        
        \begin{equation}
            \Delta\rho
                :=\frac{\rho_\text{f}-\rho_\text{i}}{\rho_\text{i}}
        \end{equation}

        In reality, this mass error should be exactly equal to zero. Otherwise, mass conservation would not be given, since the movement of mass from one point in space to another is not included in our model. \\
        
        The numerical integration introduces an error though, which ideally should be kept at machine precision. % TODO Rewrite this.

    % }}}
    % Explicit Euler Scheme {{{ 
    \subsection{Explicit Euler Scheme}

        A naive approach for solving the Smoluchowski equation numerically is given by the simple 
        explicit Euler integration scheme, which we will briefly address here. Assuming a constant 
        time-step size $\Delta t\in\mathbb R_+$, the elapsed time after $m\in\mathbb N_0$ integration 
        steps can be expressed as 
        \begin{equation}
            t_m
                =t_0+m\cdot\Delta t,
        \end{equation}
        where $t_0$ is the time value at the start of the integration.\\
        
        Now, the goal is to find the corresponding values $n_k^m$ for the particle mass 
        distribution:
        \begin{equation}
            n_k^m
                :=n(m=m_k,\ t=t_m)
        \end{equation}
        
        We define the differences
        \begin{align}
            \Delta n_k
                &=n_k^m-n_k^{m-1}
            \ \ \ \text{and}\ \ \
            \\
            \Delta t
                &=t_m-t_{m-1}
        \end{align}
        which, in turn, can be used to define the 1st order foward finite difference
        \begin{equation}
            \text{FFD}
                =\frac{\Delta n_k}{\Delta t}
        \end{equation}
        
        The finite difference can now be used as an approximation for the temporal derivative 
        of $n$:
        \begin{equation}
            \pderiv{n_k}{t}
                \approx\text{FFD}
        \end{equation}
        
        Plugging in \cref{eq:discrete_smoluchowski_equation} and rearranging for $\Delta n_k$ 
        leads to
        \begin{equation}
            \Delta n_k
            =\Delta t\cdot
                \sum_{i=1}^{\mathcal N_m}\sum_{j=1}^{\mathcal N_m}
                K_{kij}\cdot n_i\cdot n_j
        \end{equation}
        
        % TODO Be consistent: "time step" or "time-step" ?
        This can now be used an approximate value for the change in $n_k$ from one time-step to 
        the next, i.e.
        \begin{equation}
            \begin{split}
                n_k^m
                    &=n_k^{m-1}+\Delta n_k
                \\
                    &=n_k^{m-1}+\Delta t\cdot
                        \sum_{i=1}^{\mathcal N_m}\sum_{j=1}^{\mathcal N_m}
                        K_{kij}\cdot n_i\cdot n_j
            \end{split}
        \end{equation}
        
        % TODO Cite CFL ?
        % TODO Add CFL to abbreviations
        In order to ensure stability of the numerical integration, the step size needs to respect the 
        Courant-Friedrichs-Lewy (CFL) criterion, which provides an upper limit for the values that 
        $\Delta t$ can take on \cite{courant_friedrichs_lewy_1928}.\\
        
        \todo{Formulate CFL criterion for Smoluchowski equation.}

    % }}}
    % Implicit Radau Scheme {{{ 
    \subsection{Implicit Radau Scheme}

        \todo{Runge-Kutta scheme} \\
        \todo{Here, 4th order (correct?)} \\

        \todo{Built upon `scipy` Python library 
        (more specifically, `scipy.integrate.solve\_ivp` function)} \\
        \todo{Implemented by my supervisor Prof. Dr. Cornelis P. Dullemond [cite?]} \\

        \todo{Accuracy} \\
        \todo{Stability, Mass Conservation} \\

    % }}}
% }}}
